---
title: "Question 5"
author: "Matteo Venturini"
date: "`r Sys.Date()`"
output:
  html_document:
    # df_print: paged
---

```{r}
############################################################
# PACKAGES REQUIRED FOR QUESTION 5
############################################################

libraries_q5 <- c(
  "haven",        # read_sas
  "dplyr",        # data manipulation
  "tidyr",        # long reshape
  "ggplot2",      # plots
  "reshape2",     # melt()
  "viridis",      # color scales
  "knitr",        # summary tables
  "kableExtra",   # styled tables
  "e1071",        # skewness()
  "nlme",         # lme (for residual structure checks)
  "lmerTest",     # lmer (for mixed models with p-values)
  "patchwork"     # combining plots
)

# Install missing packages
for (pkg in libraries_q5) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

# Load packages
invisible(lapply(libraries_q5, library, character.only = TRUE))


############################################################
# LOAD DATA
############################################################

setwd("./../data")
dat <- read_sas("alzheimer25.sas7bdat")


############################################################
# DATA PREPARATION (ADAPTED FOR BPRS)
############################################################

reshape_dat <- function(dat) {
  dat_long <- dat %>%
    pivot_longer(
      cols = matches("^bprs\\d+"),            # Select only bprs0 - bprs6
      names_to = c(".value", "time"),
      names_pattern = "(.+)(\\d+)"
    )
  dat_long
}

to_factor <- function(dat_long) {
  dat_long <- dat_long %>%
    mutate(
      time     = as.factor(time),             # coded 0–6 as factor
      sex      = as.factor(sex),
      edu      = as.factor(edu),
      trial    = as.factor(trial),
      job      = as.factor(job),
      wzc      = as.factor(wzc),
      time_num = as.numeric(as.character(time)), # coded 0–6 numeric
      patid    = as.character(patid)          # Ensure ID is character for joins later
    )
  dat_long
}

# Create long-format dataset
dat_long <- reshape_dat(dat)
dat_long <- to_factor(dat_long)
```

## Q5. Random-Effects Model vs. Multivariate Model

Formulate a plausible random-effects model. Fit your model, and compare the results with those from the multivariate model.

### 1\. Choose the Random-Effects Structure

We fit several candidate models with varying random-effects structures. We use AIC and BIC for comparison rather than a Likelihood Ratio Test (LRT) due to potential boundary issues when testing variance components.

```{r}
# Baseline linear model (Fixed effects only)
m1 <- lm(bprs ~ time_num * (sex + age + wzc + adl + job) + taupet0 + abpet0 + cdrsb0, 
         data = dat_long)

# Random Intercept (patid)
m2 <- lmer(bprs ~ time_num * (sex + age + wzc + adl + job) + taupet0 + abpet0 + cdrsb0 + (1 | patid),
           data = dat_long, REML = TRUE) 

# Random Intercept + Slope (patid)
m3 <- lmer(bprs ~ time_num * (sex + age + wzc + adl + job) + taupet0 + abpet0 + cdrsb0 + (time_num | patid),
           data = dat_long, REML = TRUE) 

# Nested Random Intercepts (trial/patid)
m4 <- lmer(bprs ~ time_num * (sex + age + wzc + adl + job) + taupet0 + abpet0 + cdrsb0 + (1 | trial/patid),
           data = dat_long, REML = TRUE) 

# Nested Random Intercepts + Slopes (trial/patid)
m5 <- lmer(bprs ~ time_num * (sex + age + wzc + adl + job) + taupet0 + abpet0 + cdrsb0 + (time_num | trial/patid), 
           data = dat_long, REML = TRUE) 

# Random Intercept (trial) + Random Intercept/Slope (patid)
# Note: This treats trial and patid as crossed or partially crossed/nested structure efficiently
m4.5 <- lmer(bprs ~ time_num * (sex + age + wzc + adl + job) + taupet0 + abpet0 + cdrsb0 + (1 | trial) + (time_num | patid),
             data = dat_long, REML = TRUE) 

# Compare fit statistics
results <- data.frame(
  Model = c("m1 (LM)", "m2 (RI patid)", "m3 (RIS patid)", "m4 (RI trial/patid)", "m5 (RIS trial/patid)", "m4.5 (RI trial + RIS patid)"),
  AIC = AIC(m1, m2, m3, m4, m5, m4.5),
  BIC = BIC(m1, m2, m3, m4, m5, m4.5)
)

print(results)
```

**Decision:** We proceed with the random-effects structure of **Model m4.5** (Random intercept for trial, Random intercept and slope for patient), as it provides the optimal balance of fit and complexity.

### 2\. Check Residual Correlation Structure

We examine the residuals to see if a more complex correlation structure (like AR(1) or Compound Symmetry) is required.

```{r}
# Define the fixed effects formula
formula_fe <- bprs ~ time_num * (sex + age + wzc + adl + job) + taupet0 + abpet0 + cdrsb0

# Fit Model 4.5 using lme (nlme package) to allow correlation structure testing
model_no_corr <- lme(
  fixed = formula_fe,
  data = dat_long,
  random = list(trial = ~ 1, patid = ~ time_num), 
  method = "REML",
  na.action = na.omit 
)

# --- Visualization: Residual Correlation Matrix ---
residuals_df <- data.frame(
  patid = model_no_corr$groups$patid,
  trial = model_no_corr$groups$trial,
  time_num = getData(model_no_corr)$time_num, 
  residual = residuals(model_no_corr, type = "normalized")
)

residuals_wide <- residuals_df %>%
  pivot_wider(id_cols = patid, names_from = time_num, values_from = residual, names_prefix = "Year_")

# Correlation matrix of residuals
correlation_matrix <- cor(residuals_wide %>% select(starts_with("Year_")), use = "pairwise.complete.obs")
melted <- melt(correlation_matrix)

ggplot(melted, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile(color = "white", linewidth = 0.4) + 
  scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0, limits = c(-1, 1), name = "Correlation") +
  coord_fixed() + 
  labs(title = "Correlation Heatmap of Within-Subject Residuals") +
  theme_minimal()
```

The heatmap suggests low residual correlation. We formally test this against AR(1) and Compound Symmetry structures.

```{r}
# Test Compound Symmetry
model_compsymm <- lme(
  fixed = formula_fe,
  data = dat_long,
  random = list(trial = ~ 1, patid = ~ time_num), 
  correlation = corCompSymm(form = ~ 1 | trial/patid), 
  method = "REML", na.action = na.omit 
)

# Test AR(1)
model_ar1 <- lme(
  fixed = formula_fe,
  data = dat_long,
  random = list(trial = ~ 1, patid = ~ time_num),
  correlation = corAR1(form = ~ time_num | trial/patid), 
  method = "REML", na.action = na.omit 
)

# Comparisons
anova(model_no_corr, model_compsymm)
anova(model_no_corr, model_ar1)
```

**Conclusion:** Neither complex correlation structure significantly improves the fit. We proceed assuming independent residuals.

### 3\. Choose the Mean Structure

We now refine the fixed effects. We fit models using `REML = FALSE` (Maximum Likelihood) to compare mean structures.

```{r}
# Full fixed effects structure (REML = FALSE)
m_full <- lmer(bprs ~ time_num * (sex + age + wzc + adl + job + taupet0 + abpet0 + cdrsb0) + (1 | trial) + (time_num | patid),
               data = dat_long, REML = FALSE) 

# Reduced fixed effects structure (REML = FALSE)
# Example: Removing interactions with taupet/abpet if they were included, 
# or simplifying based on significance. 
# Here we test the structure provided in the prompt logic:
m_reduced <- lmer(bprs ~ time_num * (sex + age + adl + job + cdrsb0) + taupet0 + abpet0 + wzc + (1 | trial) + (time_num | patid),
             data = dat_long, REML = FALSE) 

summary(m_reduced)
anova(m_full, m_reduced)
```

### 4\. Final Model and Diagnostics

We refit the chosen model using **REML**.

```{r}
final_model <- lmer(bprs ~ time_num * (sex + age + adl + job + cdrsb0) + taupet0 + abpet0 + wzc + (1 | trial) + (time_num | patid),
             data = dat_long, REML = TRUE)

summary(final_model)

# Residual Diagnostics
res <- resid(final_model)
fit <- fitted(final_model)

par(mfrow = c(1, 3))
# 1. Residuals vs Fitted
plot(fit, res, main = "Residuals vs Fitted", xlab = "Fitted", ylab = "Residuals")
abline(h = 0, col = "red")

# 2. QQ Plot
qqnorm(res, main = "Normal Q-Q Plot"); qqline(res, col = "red")

# 3. Histogram
hist(res, breaks = 40, main = "Histogram of Residuals", xlab = "Residuals")
par(mfrow = c(1, 1))
```

**Random Effects Normality Check:**

```{r}
re <- ranef(final_model)

par(mfrow = c(1, 3))
qqnorm(re$patid[, "(Intercept)"], main = "Patient Random Intercepts"); qqline(re$patid[, "(Intercept)"], col = "red")
qqnorm(re$patid[, "time_num"], main = "Patient Random Slopes"); qqline(re$patid[, "time_num"], col = "red")
qqnorm(re$trial[, "(Intercept)"], main = "Trial Random Intercepts"); qqline(re$trial[, "(Intercept)"], col = "red")
par(mfrow = c(1, 1))
```

### 5\. Comparison: LMM vs. Two-Stage Analysis (Shrinkage)

We compare the LMM random effects against a "Two-Stage" approach where we calculate OLS slopes/intercepts for each individual (Stage 1) and then regress them on covariates (Stage 2). This demonstrates the "shrinkage" property of LMMs.

```{r, warning=FALSE, message=FALSE}
# --- PREP: Filter for valid subjects ---
dat2 <- dat %>%
  filter(!patid %in% patid[is.na(bprs1)]) %>% 
  mutate(patid = as.character(patid))

dat_long2 <- reshape_dat(dat2) %>% 
  to_factor()

# --- STAGE 1: Individual OLS Regressions ---
stage1_coefs <- dat_long2 %>%
  filter(!is.na(bprs)) %>%
  group_by(patid) %>%
  summarise(
    beta0 = coef(lm(bprs ~ time_num))[1],
    beta1 = coef(lm(bprs ~ time_num))[2]
  ) %>%
  ungroup()

# Visualizing the empirical distribution of OLS coefficients
p_beta0 <- ggplot(stage1_coefs, aes(x = beta0)) + geom_histogram(bins = 30, fill = "#603655", color="white") + labs(title="Empirical Beta0") + theme_minimal()
p_beta1 <- ggplot(stage1_coefs, aes(x = beta1)) + geom_histogram(bins = 30, fill = "#c49235", color="white") + labs(title="Empirical Beta1") + theme_minimal()
p_beta0 | p_beta1

# --- STAGE 2: Regress Coefficients on Covariates ---
# Join baseline covariates
baseline_covariates <- dat2 %>%
  group_by(patid) %>%
  slice(1) %>%
  select(patid, age, sex, trial, edu, bmi, inkomen, job, adl, wzc, cdrsb0, abpet0, taupet0)

stage2_data <- inner_join(stage1_coefs, baseline_covariates, by = "patid") %>%
  filter(!is.na(beta0) & !is.na(beta1))

# Linear models for Stage 2 (Matching LMM fixed effects structure)
lm_intercept <- lm(beta0 ~ age + sex + adl + job + cdrsb0 + taupet0 + abpet0 + wzc, data = stage2_data)
lm_slope     <- lm(beta1 ~ age + sex + adl + job + cdrsb0, data = stage2_data)

# Extract Stage 2 Residuals (Observed - Predicted)
stage2_data$resid_intercept <- residuals(lm_intercept)
stage2_data$resid_slope     <- residuals(lm_slope)

# --- COMPARISON: Retrieve LMM Random Effects ---
# We use the random effects from our Final Model (m5/final_model)
lmm_ranef <- ranef(final_model)$patid
lmm_ranef$patid <- rownames(lmm_ranef)
lmm_ranef <- lmm_ranef %>%
  rename(lmm_random_intercept = `(Intercept)`,
         lmm_random_slope = time_num)

# Merge Stage 2 Residuals with LMM Random Effects
plot_data <- inner_join(stage2_data, lmm_ranef, by = "patid")

# --- PLOTTING SHRINKAGE ---

# Plot 1: Intercepts
p1 <- ggplot(plot_data, aes(x = resid_intercept, y = lmm_random_intercept)) +
  geom_point(alpha = 0.5, color = "#603655") +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(method="lm", se=FALSE, color="gray40", linetype="dotted") +
  labs(title = "Intercepts: OLS vs LMM",
       subtitle = "Slope < 1 indicates shrinkage",
       x = "Stage 2 OLS Residuals",
       y = "LMM Random Intercepts (Shrunk)") +
  theme_minimal()

# Plot 2: Slopes
p2 <- ggplot(plot_data, aes(x = resid_slope, y = lmm_random_slope)) +
  geom_point(alpha = 0.5, color = "#c49235") +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(method="lm", se=FALSE, color="gray40", linetype="dotted") +
  labs(title = "Slopes: OLS vs LMM",
       subtitle = "Notice the stronger shrinkage toward 0",
       x = "Stage 2 OLS Residuals",
       y = "LMM Random Slopes (Shrunk)") +
  theme_minimal()

p1 | p2
```


