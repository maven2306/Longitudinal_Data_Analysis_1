---
title: "Question 4 – Two-Stage Analysis"
author: "Ermioni Athanasiadi"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
############################################################
# PACKAGES REQUIRED FOR QUESTION 4
############################################################

libraries_q4 <- c(
  "haven", "dplyr", "tidyr", "ggplot2",
  "nlme", "data.table", "broom", "patchwork"
)

for (pkg in libraries_q4) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}
invisible(lapply(libraries_q4, library, character.only = TRUE))


############################################################
# LOAD DATA (SELF-CONTAINED)
############################################################

setwd("./../data")
dat <- read_sas("alzheimer25.sas7bdat")

############################################################
# STANDARD DATA PREP (MATCHING Q1 + Q2)
############################################################

reshape_dat <- function(dat) {
  dat %>%
    pivot_longer(
      cols = matches("^(bprs|cdrsb|abpet|taupet)\\d+"),
      names_to = c(".value", "time"),
      names_pattern = "(.+)(\\d+)"
    )
}

to_factor <- function(dat_long) {
  dat_long %>%
    mutate(
      sex      = as.factor(sex),
      edu      = as.factor(edu),
      trial    = as.factor(trial),
      job      = as.factor(job),
      wzc      = as.factor(wzc),
      time     = as.factor(time),          # 0–6
      time_num = as.numeric(time) - 1      # 0–6 numeric
    )
}

dat_long <- reshape_dat(dat)
dat_long <- to_factor(dat_long)
dat_long <- dat_long %>% mutate(patid = as.factor(patid))

```


# Stage 1 — Fit subject-specific regressions

```{r}
dat_long_cmpl <- dat_long %>%
  select(patid, time_num, bprs, age, sex, trial, edu, bmi,
         inkomen, job, adl, wzc, cdrsb, abpet, taupet) %>%
  na.omit()

dat_long_cmpl2 <- dat_long_cmpl %>%
  group_by(patid) %>%
  filter(n() > 1) %>%
  ungroup()
```

```{r}
stage1_coefs <- dat_long_cmpl2 %>%
  group_by(patid) %>%
  summarise(
    beta0 = coef(lm(bprs ~ time_num))[1],
    beta1 = coef(lm(bprs ~ time_num))[2],
    .groups = "drop"
  )
```

# Stage 2 — Merge baseline covariates

```{r}
stage2_covars <- dat_long_cmpl %>%
  group_by(patid) %>%
  slice(1) %>%
  ungroup() %>%
  select(patid, age, sex, trial, edu, bmi,
         inkomen, job, adl, wzc, cdrsb, abpet, taupet)

df_twostage <- left_join(stage1_coefs, stage2_covars, by = "patid")
```

# Stage 2 — Fit models for β₀ and β₁

```{r}
m_beta0 <- lm(beta0 ~ age + sex + trial + edu + bmi +
                inkomen + job + adl + wzc + cdrsb + abpet + taupet,
              data = df_twostage)

m_beta1 <- lm(beta1 ~ age + sex + trial + edu + bmi +
                inkomen + job + adl + wzc + cdrsb + abpet + taupet,
              data = df_twostage)

summary(m_beta0)
summary(m_beta1)
```

# Optional: Multivariate Stage-2 Model

```{r}
form_stage2 <- cbind(beta0, beta1) ~ age + sex + trial + edu + bmi +
  inkomen + job + adl + wzc + cdrsb + abpet + taupet

m_multi <- lm(form_stage2, data = df_twostage)

summary(m_multi)

cor(residuals(m_multi))
```

# Optional diagnostics

```{r}
p0 <- ggplot(df_twostage, aes(beta0)) +
  geom_histogram(bins = 30, fill = "grey70", color = "black") +
  labs(title = "Distribution of β0 (Intercepts)")

p1 <- ggplot(df_twostage, aes(beta1)) +
  geom_histogram(bins = 30, fill = "grey70", color = "black") +
  labs(title = "Distribution of β1 (Slopes)")

p0 | p1
```

```{r}
rm(stage1_coefs, stage2_covars)
```

```

